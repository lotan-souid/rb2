[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-31 12:50:00.118216",
  "module": "Development",
  "name": "Calculate nested fields in Development Task",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Development Task",
  "script": "# התחלה - רק אם זה לא קבוצה, נתחיל לעדכן את ההורים\r\nif not doc.is_group:\r\n    parent_name = doc.parent_development_task\r\n\r\n    while parent_name:\r\n        parent_doc = frappe.get_doc(\"Development Task\", parent_name)\r\n\r\n        # שליפת כל הילדים הישירים של ההורה הנוכחי\r\n        child_tasks = frappe.get_all(\r\n            \"Development Task\",\r\n            filters={\"parent_development_task\": parent_name},\r\n            fields=[\"name\", \"estimated_cost\", \"actual_cost\", \"is_group\"]\r\n        )\r\n\r\n        total_estimated = 0\r\n        total_actual = 0\r\n\r\n        i = 0\r\n        while i < len(child_tasks):\r\n            child = child_tasks[i]\r\n            if child.get(\"is_group\"):\r\n                sub_tasks = frappe.get_all(\r\n                    \"Development Task\",\r\n                    filters={\"parent_development_task\": child.get(\"name\")},\r\n                    fields=[\"estimated_cost\", \"actual_cost\"]\r\n                )\r\n                j = 0\r\n                while j < len(sub_tasks):\r\n                    total_estimated = total_estimated + (sub_tasks[j].get(\"estimated_cost\") or 0)\r\n                    total_actual = total_actual + (sub_tasks[j].get(\"actual_cost\") or 0)\r\n                    j = j + 1\r\n            else:\r\n                total_estimated = total_estimated + (child.get(\"estimated_cost\") or 0)\r\n                total_actual = total_actual + (child.get(\"actual_cost\") or 0)\r\n            i = i + 1\r\n\r\n        # עדכון ההורה עם הסכומים החדשים\r\n        frappe.db.set_value(\"Development Task\", parent_name, {\r\n            \"estimated_cost\": total_estimated,\r\n            \"actual_cost\": total_actual\r\n        })\r\n\r\n        # המשך ללמעלה בהיררכיה\r\n        parent_name = parent_doc.parent_development_task\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-30 09:33:20.235761",
  "module": "Development",
  "name": "Assign lot",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Arrangement File",
  "script": "if doc.assigned_lot:\r\n    frappe.db.set_value(\"Lot\", doc.assigned_lot, \"assigned_arrangement_file\", doc.name)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-30 10:04:42.221844",
  "module": "Development",
  "name": "Assign Related Development Project in Lot from",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Development Project",
  "script": "lots = frappe.get_all(\"Lot\", filters={\"plan\": doc.plan}, fields=[\"name\"])\r\nfor lot in lots:\r\n    frappe.db.set_value(\"Lot\", lot.name, \"related_project\", doc.name)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-30 17:25:59.664646",
  "module": "Development",
  "name": "Validate Root Task",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Development Project",
  "script": "if doc.root_task:\r\n    frappe.db.set_value(\"Development Task\", doc.root_task, \"development_project\", doc.name)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-30 17:25:59.679508",
  "module": "Development",
  "name": "Validate Root Task In Development Task",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Development Task",
  "script": "# נוודא שזו משימת Root (אין parent וגם יש קישור לפרויקט)\r\nif not doc.parent_development_task and doc.development_project:\r\n    frappe.db.set_value(\"Development Project\", doc.development_project, \"root_task\", doc.name)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-30 17:27:33.114895",
  "module": "Development",
  "name": "Create Root Task for each Development Project",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Development Project",
  "script": "# יצירת Root Task אוטומטית בעת יצירת Development Project\r\n\r\nroot_task = frappe.new_doc(\"Development Task\")\r\nroot_task.task_name = f\"משימות לפרויקט {doc.project_name or doc.name}\"\r\nroot_task.is_group = 1\r\nroot_task.development_project = doc.name\r\nroot_task.insert(ignore_permissions=True)\r\n\r\n# עדכון קישור בפרויקט\r\nfrappe.db.set_value(\"Development Project\", doc.name, \"root_task\", root_task.name)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-30 18:03:35.329675",
  "module": "Development",
  "name": "Update children Development Project field in Development Task",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Development Task",
  "script": "# ודא שלכל משימה בעץ יש את ה-development_project של ה-root\r\n\r\ndef update_children_project(doc):\r\n    if doc.development_project:\r\n        children = frappe.get_all(\"Development Task\", filters={\"parent_development_task\": doc.name}, fields=[\"name\"])\r\n        for child in children:\r\n            frappe.db.set_value(\"Development Task\", child.name, \"development_project\", doc.development_project)\r\n\r\nupdate_children_project(doc)\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-30 18:12:43.756508",
  "module": "Development",
  "name": "Children task inherit from parent",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Development Task",
  "script": "# אם המשימה הנוכחית היא תת-משימה ויש לה אב, נוריש ממנה את הפרויקט\r\n\r\nif doc.parent_development_task and not doc.development_project:\r\n    parent_project = frappe.db.get_value(\"Development Task\", doc.parent_development_task, \"development_project\")\r\n    if parent_project:\r\n        doc.development_project = parent_project\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-25 14:36:30.859419",
  "module": "Development",
  "name": "Update Current Status from Latest Committee Decision",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Project Approval Committee",
  "script": "# Update Current Status from Latest Committee Decision\n\nif doc.meeting_history:\n    latest_meeting = sorted(doc.meeting_history, key=lambda m: m.meeting_date or frappe.utils.nowdate())[-1]\n    doc.current_status = latest_meeting.decision\nelse:\n    doc.current_status = None\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-26 18:07:17.560750",
  "module": "Development",
  "name": "Calculate Total Costs from Root Tasks",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Development Project",
  "script": "# Calculate Total Estimated & Actual Cost from linked Root Tasks\n\nroot_tasks = frappe.get_all(\n    \"Development Task\",\n    filters={\n        \"development_project\": doc.name,\n        \"parent_development_task\": [\"is\", \"not set\"]\n    },\n    fields=[\"estimated_cost\", \"actual_cost\"]\n)\n\ndoc.total_estimated_cost = sum(task.estimated_cost or 0 for task in root_tasks)\ndoc.total_actual_cost = sum(task.actual_cost or 0 for task in root_tasks)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-29 10:54:40.017343",
  "module": "Arrangement",
  "name": "Set Evacuee full name",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Evacuee",
  "script": "if doc.first_name and doc.last_name:\r\n    doc.full_name = f\"{doc.first_name} {doc.last_name}\"\r\nelse:\r\n    doc.full_name = (doc.first_name or '') + (doc.last_name or '')\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-29 11:10:06.187112",
  "module": "Arrangement",
  "name": "Validate Arrangement File Fields",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Arrangement File",
  "script": "if doc.evacuee_a and doc.evacuee_b and doc.evacuee_a == doc.evacuee_b:\r\n    frappe.throw(\"Evacuee A and Evacuee B cannot be the same person.\")\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-29 14:54:10.716382",
  "module": "rb",
  "name": "Validate Evacuee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Evacuee",
  "script": "# שלבים:\r\n# - הסרת תווים שאינם ספרות\r\n# - בדיקה אם יש 10 ספרות\r\n# - עיצוב לפורמט xxx-xxx-xxxx\r\n\r\nif not doc.phone:\r\n    frappe.throw(\"יש להזין מספר טלפון\")\r\n\r\n# הסר תווים לא מספריים (רק ספרות נשארות)\r\ndigits = ''.join([c for c in doc.phone if c.isdigit()])\r\n\r\nif len(digits) != 10:\r\n    frappe.throw(\"מספר הטלפון חייב להכיל 10 ספרות בדיוק\")\r\n\r\n# הפורמט הסופי: xxx-xxx-xxxx\r\ndoc.phone = f\"{digits[:3]}-{digits[3:6]}-{digits[6:]}\"\r\n",
  "script_type": "DocType Event"
 }
]