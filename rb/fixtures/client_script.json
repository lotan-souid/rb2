[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Development Project",
  "enabled": 1,
  "modified": "2025-08-24 23:00:19.803468",
  "module": "Development",
  "name": "Calculate Cost Per Lot - Average Lot Size Based",
  "script": "frappe.ui.form.on('Development Project', {\n    estimated_total_cost: function(frm) {\n        calculate_cost_per_lot(frm);\n    },\n    residential_area_sqm: function(frm) {\n        calculate_cost_per_lot(frm);\n    },\n    residential_lots: function(frm) {\n        calculate_cost_per_lot(frm);\n    },\n    refresh: function(frm) {\n        // 砖 专砖 砖驻住 注\n        calculate_cost_per_lot(frm);\n    }\n});\n\nfunction calculate_cost_per_lot(frm) {\n    let total_cost = frm.doc.estimated_total_cost || 0;\n    let area_sqm = frm.doc.residential_area_sqm || 0;\n    let lots = frm.doc.residential_lots || 0;\n    \n    if (lots > 0 && area_sqm > 0 && total_cost > 0) {\n        // 砖  专砖 爪注\n        let avg_lot_size = area_sqm / lots;\n        \n        // 砖 注转 \"专\n        let cost_per_sqm = total_cost / area_sqm;\n        \n        // 砖 注转 专砖 爪注 = 注转 \"专   专砖 爪注\n        let cost_per_lot = cost_per_sqm * avg_lot_size;\n        \n        // 注 砖\n        frm.set_value('cost_per_lot', cost_per_lot);\n        \n        console.log('Cost Per Lot Calculation (Fixed):', {\n            total_cost: total_cost,\n            area_sqm: area_sqm,\n            lots: lots,\n            avg_lot_size: avg_lot_size.toFixed(2),\n            cost_per_sqm: cost_per_sqm.toFixed(2),\n            cost_per_lot: cost_per_lot.toFixed(2)\n        });\n    } else {\n        frm.set_value('cost_per_lot', 0);\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Arrangement File",
  "enabled": 1,
  "modified": "2025-08-24 23:00:12.600634",
  "module": "Arrangement",
  "name": "arrangement_file_calculations",
  "script": "frappe.ui.form.on('Arrangement File', {\n    assigned_lot: function(frm) {\n        if (frm.doc.assigned_lot) {\n            // 砖驻转 转 专砖\n            frappe.db.get_doc('Lot', frm.doc.assigned_lot).then(lot => {\n                if (lot.area_sqm && lot.cost_per_sqm) {\n                    // 砖 专 专砖\n                    let lot_price = lot.area_sqm * lot.cost_per_sqm;\n                    frm.set_value('lot_price', lot_price);\n                    \n                    // 注 住住 驻转\n                    if (lot.development_status) {\n                        frm.set_value('lot_development_status', lot.development_status);\n                    }\n                }\n            });\n        } else {\n            // 拽 砖转 砖专  专 专砖\n            frm.set_value('lot_price', 0);\n            frm.set_value('lot_development_status', '');\n        }\n    },\n    \n    // 砖 砖 砖专 注转 驻住\n    refresh: function(frm) {\n        if (frm.doc.assigned_lot) {\n            // 驻注转 砖 砖\n            frm.trigger('assigned_lot');\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Lot",
  "enabled": 1,
  "modified": "2025-08-24 23:00:04.210005",
  "module": "Planning",
  "name": "lot_development_sync",
  "script": "frappe.ui.form.on('Lot', {\n    related_project: function(frm) {\n        if (frm.doc.related_project) {\n            // 砖驻转 转 驻专拽 驻转\n            frappe.db.get_doc('Development Project', frm.doc.related_project).then(project => {\n                // 注 住住 驻转\n                frm.set_value('development_status', project.status);\n                \n                // 注 注转 专 专注\n                if (project.estimated_cost_per_sqm) {\n                    frm.set_value('cost_per_sqm', project.estimated_cost_per_sqm);\n                }\n            }).catch(error => {\n                console.log('Error fetching development project:', error);\n            });\n        } else {\n            // 拽 砖转 砖专  专 驻专拽\n            frm.set_value('development_status', '');\n            frm.set_value('cost_per_sqm', 0);\n        }\n    },\n    \n    // 注 砖专 注转 驻住\n    refresh: function(frm) {\n        if (frm.doc.related_project) {\n            frm.trigger('related_project');\n        }\n    },\n    \n    // 注 砖专 注转 转转 砖 Plan\n    plan: function(frm) {\n        if (frm.doc.plan) {\n            // 砖驻转 驻专拽 驻转 转转\n            frappe.db.get_value('Plan', frm.doc.plan, 'development_project').then(response => {\n                if (response.message && response.message.development_project) {\n                    frm.set_value('related_project', response.message.development_project);\n                }\n            });\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Development Project",
  "enabled": 1,
  "modified": "2025-07-26 18:09:25.817117",
  "module": "Development",
  "name": "Filter Root Tasks in Main Tasks Table",
  "script": "frappe.ui.form.on('Development Project', {\n  onload: function(frm) {\n    frm.set_query('task', 'main_tasks', function() {\n      return {\n        filters: {\n          development_project: frm.doc.name,\n          parent_development_task: [\"is\", \"not set\"]\n        }\n      };\n    });\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Lot",
  "enabled": 1,
  "modified": "2025-07-27 21:29:30.029632",
  "module": "Planning",
  "name": "Set Lot ID from Lot Number and Plan",
  "script": "frappe.ui.form.on('Lot', {\n    lot_number: function(frm) {\n        set_lot_id(frm);\n    },\n    plan: function(frm) {\n        set_lot_id(frm);\n    },\n    plan_number: function(frm) {\n        set_lot_id(frm);\n    }\n});\n\nfunction set_lot_id(frm) {\n    if (frm.doc.lot_number && frm.doc.plan_number) {\n        frm.set_value('lot_id', `${frm.doc.lot_number}@${frm.doc.plan_number}`);\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Evacuee",
  "enabled": 0,
  "modified": "2025-07-29 10:52:02.556652",
  "module": "Arrangement",
  "name": "Set Evacuee full name",
  "script": "frappe.ui.form.on('Evacuee', {\n    first_name: function(frm) {\n        set_full_name(frm);\n    },\n    last_name: function(frm) {\n        set_full_name(frm);\n    }\n});\n\nfunction set_full_name(frm) {\n    if (frm.doc.first_name && frm.doc.last_name) {\n        frm.set_value('full_name', `${frm.doc.first_name} ${frm.doc.last_name}`);\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Arrangement File",
  "enabled": 1,
  "modified": "2025-07-29 12:32:20.808344",
  "module": "Arrangement",
  "name": "Calculate Total Fixtures Compensation field",
  "script": "frappe.ui.form.on('Fixture Compensation', {\n    fixture_compensation_add: function(frm) {\n        calculate_total_fixture_compensation(frm);\n    },\n    fixture_compensation_remove: function(frm) {\n        calculate_total_fixture_compensation(frm);\n    },\n    compensation_amount: function(frm) {\n        calculate_total_fixture_compensation(frm);\n    },\n    quantity: function(frm) {\n        calculate_total_fixture_compensation(frm);\n    }\n});\n\nfunction calculate_total_fixture_compensation(frm) {\n    let total = 0;\n    (frm.doc.fixture_compensation || []).forEach(row => {\n        if (row.compensation_amount) {\n            total += row.compensation_amount;\n        }\n    });\n    frm.set_value('total_fixture_compensation', total);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Development Project",
  "enabled": 1,
  "modified": "2025-07-30 22:58:01.835994",
  "module": "Development",
  "name": "Filter Development Tasks by Development Project",
  "script": "frappe.ui.form.on('Development Project', {\n    refresh(frm) {\n        if (frm.doc.name) {\n            // 驻转专 注专 专砖转 砖转 住转\n            frm.add_custom_button(' 专砖转 砖转 驻专拽', () => {\n                frappe.set_route(\"List\", \"Development Task\", {\n                    development_project: frm.doc.name\n                });\n            });\n\n            // 驻转专 注抓 砖转 (Tree View) 住 驻 驻专拽\n            frm.add_custom_button(' 注抓 砖转 驻专拽', () => {\n                frappe.set_route(\"Tree\", \"Development Task\", {\n                    development_project: frm.doc.name\n                });\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Plan",
  "enabled": 1,
  "modified": "2025-08-24 22:59:53.982400",
  "module": "Planning",
  "name": "Plan Lots Summary Refresh Button",
  "script": "frappe.ui.form.on('Plan', {\n    refresh: function(frm) {\n        // Add custom button to refresh lots summary\n        if (!frm.is_new()) {\n            // Add button to the main toolbar (more visible)\n            frm.add_custom_button(__(' Refresh Lots Summary'), function() {\n                // Show loading indicator\n                frappe.show_alert({\n                    message: __('Calculating lots summary...'),\n                    indicator: 'blue'\n                });\n                \n                frappe.call({\n                    method: 'frappe.client.get_list',\n                    args: {\n                        doctype: 'Lot',\n                        filters: {'plan': frm.doc.name},\n                        fields: ['area_sqm']\n                    },\n                    callback: function(r) {\n                        if (r.message) {\n                            let lots = r.message;\n                            let total_lots = lots.length;\n                            let total_area = lots.reduce((sum, lot) => sum + (lot.area_sqm || 0), 0);\n                            let residential_lots = lots.filter(lot => (lot.area_sqm || 0) > 0).length;\n                            let residential_area = lots.filter(lot => (lot.area_sqm || 0) > 0).reduce((sum, lot) => sum + lot.area_sqm, 0);\n                            \n                            // Update form fields\n                            frm.set_value('total_lots', total_lots);\n                            frm.set_value('total_area_sqm', total_area);\n                            frm.set_value('residential_lots', residential_lots);\n                            frm.set_value('residential_area_sqm', residential_area);\n                            \n                            // Save the document to persist changes\n                            frm.save().then(() => {\n                                frappe.show_alert({\n                                    message: __('Lots summary updated: {0} lots, {1} sqm total', [total_lots, total_area]),\n                                    indicator: 'green'\n                                });\n                            });\n                        }\n                    },\n                    error: function(r) {\n                        frappe.show_alert({\n                            message: __('Failed to refresh lots summary: ' + (r.message || 'Unknown error')),\n                            indicator: 'red'\n                        });\n                    }\n                });\n            }).addClass('btn-warning'); // Make button more visible with warning color\n        }\n    }\n});",
  "view": "Form"
 }
]